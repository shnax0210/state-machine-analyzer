<!DOCTYPE html>
<html>
<head>
    <title>State machine analyzer</title>
    <style>
        g.graph--node_red > rect {
            fill: #ff0000;
        }

        g.graph--node_cyan > rect {
            fill: #00FFFF;
        }

        g.graph--node_blue > rect {
            fill: #0000FF;
        }

        g.graph--node_dark-blue > rect {
            fill: #0000FF;
        }

        g.graph--node_light-blue > rect {
            fill: #0000FF;
        }

        g.graph--node_purple > rect {
            fill: #800080;
        }

        g.graph--node_yellow > rect {
            fill: #FFFF00;
        }

        g.graph--node_lime > rect {
            fill: #00FF00;
        }

        g.graph--node_magenta > rect {
            fill: #FF00FF;
        }

        g.graph--node_white > rect {
            fill: #FFFFFF;
        }

        g.graph--node_silver > rect {
            fill: #C0C0C0;
        }

        g.graph--node_gray > rect {
            fill: #808080;
        }

        g.graph--node_black > rect {
            fill: #000000;
        }

        g.graph--node_orange > rect {
            fill: #FFA500;
        }

        g.graph--node_brown > rect {
            fill: #A52A2A;
        }

        g.graph--node_maroon > rect {
            fill: #800000;
        }

        g.graph--node_green > rect {
            fill: #008000;
        }

        g.graph--node_olive > rect {
            fill: #808000;
        }

        text {
            font-weight: 300;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
        }

        .node rect {
            stroke: #999;
            fill: #fff;
            stroke-width: 1.5px;
        }

        .edgePath path {
            stroke: #333;
            stroke-width: 1.5px;
        }

        body {
            background-image: url('assets/pexels-negative-space-160107.jpg');
        }
        
        .main-area {
            display: flex;
            flex-direction: column;
            width: 80%;
            margin: 0 auto;
        }
        
        .edit-area__editor {
            height: 300px;
        }
        
        .graph-area {
            height: 500px;
            overflow: scroll;
            border:2px solid #000;
        }
        
        .button {
            background-color: #008CBA;
            margin: 15px 0;
            height: 30px;
        }
    </style>
</head>
<body>

<div class="main-area">
    <div class="edit-area">
        <h1>Define all possible states</h1>
        <div id="statesEditor" class="edit-area__editor">return {
            users: {
                selectionType: "ANY_COMBINATION_OF",
                description: {
                    id: {
                        selectionType: "ANY_OF",
                        unique: true,
                        values: ["user1", "user2"]
                    },
                    products: {
                        selectionType: "ANY_COMBINATION_OF",
                        values: ["product1", "product2"]
                    }
                }
            }
        }
        </div>
    </div>

    <div class="edit-area">
        <h1>Mark states</h1>
        <div id="markStatesEditor" class="edit-area__editor">return function(state) {
            if (state.id === 10) {
                return "NoValid"
            }
        
            return "Valid";
        }
        </div>
    </div>

    <div class="edit-area">
        <h1>Define possible evens</h1>
        <div id="eventsEditor" class="edit-area__editor">
            function registerUser(state, id) {
                if (Array.from(state.users).map(user => user.id).includes(id)) {
                    return;
                }
        
                state.users.add({id: id, products: new Set()})
            }
        
            function buyProduct(state, userId, productId) {
                const users = Array.from(state.users);
                if (!users.map(user => user.id).includes(userId)) {
                    return;
                }
        
                users.find(user => user.id === userId).products.add(productId);
            }
            
            
            return {
                marks: ["Valid"],
                events: [
                    {
                        name: "RegistrationUser1",
                        handle: function (state) {
                            registerUser(state, "user1");
                        }
                    },
                    {
                        name: "RegistrationUser2",
                        handle: function (state) {
                            registerUser(state, "user2");
                        }
                    },
                    {
                        name: "User1BuyProduct1",
                        handle: function (state) {
                            buyProduct(state, "user1", "product1");
                        }
                    },
                    {
                        name: "User1BuyProduct2",
                        handle: function (state) {
                            buyProduct(state, "user1", "product2");
                        }
                    },
                    {
                        name: "User2BuyProduct1",
                        handle: function (state) {
                            buyProduct(state, "user2", "product1");
                        }
                    },
                    {
                        name: "User2BuyProduct2",
                        handle: function (state) {
                            buyProduct(state, "user2", "product2");
                        }
                    }
                ] 
            }
        </div>
    </div>
    
    <button id="buildGraph" class="button">Build graph</button>
    
    <div class="graph-area">
        <svg id="stateMachineSvg" width="3000" height="100000">
    
        </svg>
    </div>
</div>

<script src="dest/js/bundle.js"></script>
<script src="lib/ace-builds-master/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    function createEditor(elementId) {
        const editor = ace.edit(elementId);
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");

        return editor;
    }

    const statesEditor = createEditor("statesEditor");
    const markStatesEditor = createEditor("markStatesEditor");
    const eventsEditor = createEditor("eventsEditor");

    const marks = [
        {
            label: "Valid",
            color: "lime"
        },
        {
            label: "NoValid",
            color: "red"
        }
    ];

    document.getElementById("buildGraph").addEventListener("click", () => {
        stateMachine = createStateMachine(new Function(statesEditor.getValue()),
            {possibleMarks: marks, markState: new Function(markStatesEditor.getValue())()},
            new Function(eventsEditor.getValue())());

        stateMachine.render("#stateMachineSvg");
    });
</script>
</body>
</html>
